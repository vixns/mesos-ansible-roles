---

- name: install felix
  get_url: url=https://github.com/projectcalico/felix/releases/download/2.6.2/calico-felix
    dest=/usr/bin/calico-felix
    mode=0755
    checksum=md5:661f182bba8653a50ef3b33397efc7f1
  tags:
    - calico

#- name: remove libtinfo.so.5 from felix (ncurses bug)
#  file: path=/opt/felix-2.6.2/libtinfo.so.5 state=absent
#  tags:
#    - calico

#- name: link calico-iptables-plugin in the path
#  file: src=/opt/calico-felix /calico-iptables-plugin dest=/usr/bin/calico-iptables-plugin state=link
#  tags:
#    - calico

- name: install bird
  get_url: url=https://github.com/projectcalico/bird/releases/download/v0.3.1/bird
    dest=/usr/bin/bird
    mode=0755
    checksum=md5:eeb0877f9edff7662ded84b5d31c72dc
  tags:
    - calico

#- name: install bird6
#  get_url: url=https://github.com/projectcalico/bird/releases/download/v0.3.1/bird6
#    dest=/usr/bin/bird6
#    mode=0755
#    checksum=md5:a44dbb510e5c775a4020375d6dc5c375
#  tags:
#    - calico

- name: install birdcl
  get_url: url=https://github.com/projectcalico/bird/releases/download/v0.3.1/birdcl
    dest=/usr/bin/birdcl
    mode=0755
    checksum=md5:3aad4da09cc06253db98249fdadb8a52
  tags:
    - calico

#- name: install calico-bgp-daemon
#  get_url: url=https://github.com/projectcalico/calico-bgp-daemon/releases/download/v0.1.2/calico-bgp-daemon
#    dest=/usr/bin/calico-bgp-daemon
#    mode=0755    
#    checksum=md5:35eb4de05619af1e1785c462d484710f
#  tags:
#    - calico

#- name: install gobgp
#  get_url: url=https://github.com/projectcalico/calico-bgp-daemon/releases/download/v0.1.2/gobgp
#    dest=/usr/bin/gobgp
#    mode=0755
#    checksum=md5:7827276edd47358e1c3de11904efbe59
#  tags:
#    - calico

- name: install confd
  get_url: url=https://github.com/projectcalico/confd/releases/download/v0.12.1-calico-0.4.2/confd
    dest=/usr/bin/confd.static
    mode=0755
    checksum=md5:59dc3375fc67b2ef1cc3f6e35b8b851d
  tags:
    - calico

- name: install calicoctl binary
  get_url: url=https://github.com/projectcalico/calicoctl/releases/download/v1.6.2/calicoctl
    dest=/usr/bin/calicoctl.bin
    mode=0755
    checksum=md5:b9902316cef5614097e9cdcc23d396e8
  tags:
    - calico

- name: install calico-startup
  copy: src=startup dest=/usr/bin/calico-startup mode=0755
  tags:
    - calico

- name: install allocate-ipip-addr
  copy: src=allocate-ipip-addr dest=/usr/bin/allocate-ipip-addr mode=0755
  tags:
    - calico

- name: install calico dependencies
  apt: name={{ item }}
       state=latest
       default_release=stretch-backports
       install_recommends=no
       update_cache=yes
       cache_valid_time=3600
  with_items:
    - ipset
    - conntrack
  tags:
    - calico

- name: create calico directories
  file: state=directory path={{ item }}
  with_items:
    - /etc/calico
    - /etc/sv/felix
    - /etc/sv/confd
    - /etc/sv/bird
    #- /etc/sv/bird6
    - /var/run/calico
  tags:
    - calico

- name: install calico config and templates
  copy: src={{item}} dest=/etc/calico/
  with_items:
    - felix.cfg
    - confd
  tags:
    - calico

- name: update run files
  template: src={{item}}.sh.j2 dest=/etc/sv/{{item}}/run mode=0755
  with_items:
    - felix
    - confd
    - bird
    #- bird6
  notify:
    - restart {{item}}
  tags:
    - calico

- name: configure calico services
  runit: name={{item}} enabled=true state=started service_dir=/etc/service
  with_items:
    - felix
    - confd
    - bird
    #- bird6
  tags:
    - calico
